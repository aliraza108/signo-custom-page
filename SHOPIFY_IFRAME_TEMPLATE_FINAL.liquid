{% layout none %}

<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }}</title>
  {{ content_for_header }}
</head>
<body style="margin: 0; padding: 0; height: 100%; overflow: hidden;">
  <iframe
    id="designer-iframe"
    src="https://customsigns.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}"
    style="position: fixed; inset: 0; width: 100vw; height: 100vh; border: none; display: block;"
    allow="same-origin *">
  </iframe>

  <script>
    (function() {
      console.log('[Shopify] Template loaded');
      
      const iframe = document.getElementById('designer-iframe');
      const storeUrl = '{{ shop.permanent_domain }}';
      
      // Send product data to iframe
      function sendProductData() {
        if (!iframe || !iframe.contentWindow) {
          console.log('[Shopify] Iframe not ready');
          return;
        }
        
        const productData = {
          id: {{ product.id | json }},
          title: {{ product.title | json }},
          handle: {{ product.handle | json }},
          variant: {
            id: {{ product.selected_or_first_available_variant.id | json }},
            price: {{ product.selected_or_first_available_variant.price | json }}
          },
          metafields: {
            {% if product.metafields.custom.materials %}
            materials: {{ product.metafields.custom.materials | json }},
            {% endif %}
            {% if product.metafields.custom.sizes %}
            sizes: {{ product.metafields.custom.sizes | json }},
            {% endif %}
            {% if product.metafields.custom.description %}
            description: {{ product.metafields.custom.description | json }},
            {% endif %}
            {% if product.metafields.custom.price_per_sqft %}
            price_per_sqft: {{ product.metafields.custom.price_per_sqft | json }}
            {% endif %}
          },
          storeUrl: storeUrl
        };
        
        console.log('[Shopify] Sending product data to iframe');
        console.log('[Shopify] Product ID:', productData.id);
        console.log('[Shopify] Variant ID:', productData.variant.id);
        console.log('[Shopify] Store URL:', storeUrl);
        
        try {
          iframe.contentWindow.postMessage({
            type: 'SHOPIFY_PRODUCT_DATA',
            payload: productData
          }, '*');
          console.log('[Shopify] postMessage sent');
        } catch (e) {
          console.error('[Shopify] Error sending data:', e);
        }
      }
      
      // Wait for iframe to load
      iframe.addEventListener('load', function() {
        console.log('[Shopify] Iframe loaded');
        // Send data multiple times with delays
        sendProductData();
        setTimeout(sendProductData, 100);
        setTimeout(sendProductData, 500);
        setTimeout(sendProductData, 1000);
      });
      
      // If iframe already loaded
      if (iframe.readyState === 'complete') {
        sendProductData();
      }
      
      // Make store URL available to iframe via window
      window.addEventListener('message', function(event) {
        if (event.data.type === 'GET_STORE_URL') {
          event.source.postMessage({ type: 'STORE_URL', value: storeUrl }, event.origin);
        }
      });
      
      /* ========= RECEIVE ADD TO CART ========= */
      window.addEventListener("message", async function(event) {
        if (!event.data || event.data.type !== "ADD_TO_CART") return;

        try {
          const cartData = {
            id: event.data.variantId,
            quantity: event.data.quantity || 1,
            properties: event.data.properties || {}
          };

          // Add custom image if provided
          if (event.data.customImage) {
            cartData.properties['_customImage'] = event.data.customImage;
          }

          const response = await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cartData)
          });

          if (!response.ok) throw new Error('Failed to add to cart');

          const result = await response.json();
          console.log('[Shopify] Added to cart:', result);

          // Refresh cart state
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();

          document.documentElement.dispatchEvent(
            new CustomEvent('cart:refresh', { bubbles: true })
          );

          iframe.contentWindow.postMessage({
            type: 'CART_UPDATED',
            payload: { success: true, cart: cart }
          }, '*');

          // Show notification
          var note = document.createElement('div');
          note.style.cssText = 'position:fixed;top:20px;right:20px;background:#000;color:#fff;padding:15px 20px;border-radius:5px;z-index:9999;';
          note.textContent = 'Added to cart!';
          document.body.appendChild(note);
          setTimeout(function() { note.remove(); }, 3000);

          // Redirect to checkout if requested
          if (event.data.checkout) {
            window.location.href = '/checkout';
          }

        } catch (err) {
          console.error("[Shopify] Cart failed:", err);
          iframe.contentWindow.postMessage({
            type: 'CART_ERROR',
            payload: { success: false, error: err.message }
          }, '*');
        }
      });
    })();
  </script>
</body>
</html>
