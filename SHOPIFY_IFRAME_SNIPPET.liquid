{% layout none %}

<style>
  html, body {
    margin: 0 !important;
    padding: 0 !important;
    height: 100%;
    overflow: hidden;
  }

  #designer-iframe {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    border: 0;
  }
</style>

<iframe
  id="designer-iframe"
  src="https://customsigns.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}">
</iframe>

<script>
  (function() {
    const iframe = document.getElementById('designer-iframe');
    const STOREFRONT_API_VERSION = '2025-01';
    const STOREFRONT_API_TOKEN = {{ settings.storefront_api_token | default: '' | json }};
    const STOREFRONT_API_URL = '/api/' + STOREFRONT_API_VERSION + '/graphql.json';
    const STOREFRONT_CART_ID_KEY = 'signo_storefront_cart_id';

    function toVariantGid(variantId) {
      const raw = String(variantId || '').trim();
      if (!raw) return '';
      if (raw.indexOf('gid://shopify/ProductVariant/') === 0) return raw;
      const idPart = raw.split('/').pop();
      return idPart ? ('gid://shopify/ProductVariant/' + idPart) : '';
    }

    function getStoredCartId() {
      try {
        return window.localStorage.getItem(STOREFRONT_CART_ID_KEY) || '';
      } catch (e) {
        return '';
      }
    }

    function setStoredCartId(cartId) {
      if (!cartId) return;
      try {
        window.localStorage.setItem(STOREFRONT_CART_ID_KEY, cartId);
      } catch (e) {}
    }

    function hasStorefrontToken() {
      return typeof STOREFRONT_API_TOKEN === 'string' && STOREFRONT_API_TOKEN.length > 0;
    }

    async function storefrontRequest(query, variables) {
      const res = await fetch(STOREFRONT_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Shopify-Storefront-Access-Token': STOREFRONT_API_TOKEN
        },
        body: JSON.stringify({ query, variables })
      });
      const json = await res.json();
      if (!res.ok || json.errors) {
        throw new Error((json && json.errors && json.errors[0] && json.errors[0].message) || 'Storefront API request failed');
      }
      return json.data || {};
    }

    function toLineAttributes(props) {
      return Object.keys(props || {}).map(function(key) {
        return { key: String(key), value: String(props[key]) };
      });
    }

    async function addToStorefrontCart(variantId, quantity, props) {
      const merchandiseId = toVariantGid(variantId);
      if (!merchandiseId) throw new Error('Invalid variant ID for Storefront API');

      const attributes = toLineAttributes(props);
      const cartId = getStoredCartId();

      if (cartId) {
        const addLineMutation = `
          mutation cartLinesAdd($cartId: ID!, $lines: [CartLineInput!]!) {
            cartLinesAdd(cartId: $cartId, lines: $lines) {
              cart { id checkoutUrl }
              userErrors { field message }
            }
          }
        `;
        const addData = await storefrontRequest(addLineMutation, {
          cartId: cartId,
          lines: [{ merchandiseId: merchandiseId, quantity: quantity, attributes: attributes }]
        });
        const addResult = addData.cartLinesAdd;
        if (addResult && addResult.userErrors && addResult.userErrors.length > 0) {
          throw new Error(addResult.userErrors[0].message || 'Unable to add line to existing cart');
        }
        if (addResult && addResult.cart && addResult.cart.id) {
          setStoredCartId(addResult.cart.id);
        }
        return addResult ? addResult.cart : null;
      }

      const createMutation = `
        mutation cartCreate($input: CartInput!) {
          cartCreate(input: $input) {
            cart { id checkoutUrl }
            userErrors { field message }
          }
        }
      `;
      const createData = await storefrontRequest(createMutation, {
        input: {
          lines: [{ merchandiseId: merchandiseId, quantity: quantity, attributes: attributes }]
        }
      });
      const createResult = createData.cartCreate;
      if (createResult && createResult.userErrors && createResult.userErrors.length > 0) {
        throw new Error(createResult.userErrors[0].message || 'Unable to create Storefront cart');
      }
      if (createResult && createResult.cart && createResult.cart.id) {
        setStoredCartId(createResult.cart.id);
      }
      return createResult ? createResult.cart : null;
    }
    
    function sendProductData() {
      if (!iframe || !iframe.contentWindow) {
        console.log('[Shopify] Iframe not ready');
        return;
      }
      
      const productData = {
        id: {{ product.id | json }},
        title: {{ product.title | json }},
        handle: {{ product.handle | json }},
        variant: {
          id: {{ product.selected_or_first_available_variant.id | json }},
          price: {{ product.selected_or_first_available_variant.price | json }}
        },
        metafields: {
          {% if product.metafields.custom.materials %}
          materials: {{ product.metafields.custom.materials | json }},
          {% endif %}
          {% if product.metafields.custom.sizes %}
          sizes: {{ product.metafields.custom.sizes | json }},
          {% endif %}
          {% if product.metafields.custom.description %}
          description: {{ product.metafields.custom.description | json }},
          {% endif %}
          {% if product.metafields.custom.price_per_sqft %}
          price_per_sqft: {{ product.metafields.custom.price_per_sqft | json }}
          {% endif %}
        }
      };
      
      console.log('[Shopify] Sending product data:', productData);
      
      try {
        iframe.contentWindow.postMessage({
          type: 'SHOPIFY_PRODUCT_DATA',
          payload: productData
        }, '*');
        console.log('[Shopify] Data sent successfully');
      } catch (e) {
        console.error('[Shopify] Error:', e);
      }
    }
    
    // Wait for iframe to load
    iframe.addEventListener('load', function() {
      console.log('[Shopify] Iframe loaded');
      setTimeout(sendProductData, 100);
      setTimeout(sendProductData, 500);
      setTimeout(sendProductData, 1000);
    });
    
    // Also send immediately if already loaded
    if (iframe.readyState === 'complete') {
      sendProductData();
    }

    /* ========= RECEIVE ADD TO CART ========= */
    window.addEventListener("message", async function(event) {
      if (!event.data || event.data.type !== "ADD_TO_CART") return;

        try {
          const properties = event.data.properties || {};
          const rawPrice = event.data.price != null ? event.data.price : event.data.unitPrice;
          if (event.data.material) properties['Material'] = event.data.material;
          if (event.data.size) properties['Size'] = event.data.size;
          if (event.data.sides) properties['Sides'] = event.data.sides;
          if (event.data.qty != null) properties['Quantity'] = String(event.data.qty);

        const resolvedImageUrl =
          (typeof event.data.designImageUrl === 'string' && /^https?:\/\//i.test(event.data.designImageUrl) && event.data.designImageUrl) ||
          (typeof event.data.imageUrl === 'string' && /^https?:\/\//i.test(event.data.imageUrl) && event.data.imageUrl) ||
          '';
        const resolvedImageDataUrl =
          (typeof event.data.customImage === 'string' && /^data:image\//i.test(event.data.customImage) && event.data.customImage) ||
          '';
        const preferredImage = resolvedImageUrl || resolvedImageDataUrl || '';
        if (preferredImage) {
          properties['Design Image'] = preferredImage;
          properties['_Design Image URL'] = preferredImage;
          properties['_customImage'] = preferredImage;
        }
        if (rawPrice != null && rawPrice !== '') properties['Price'] = '$' + Number(rawPrice).toFixed(2);

          const cartData = {
            id: event.data.variantId,
            quantity: event.data.quantity || 1,
          properties
        };

        // Add custom image if provided (fallback when preferredImage missing)
        if (!properties['_customImage'] && event.data.customImage) {
          cartData.properties['_customImage'] = event.data.customImage;
        }

        let storefrontCart = null;
        if (hasStorefrontToken()) {
          storefrontCart = await addToStorefrontCart(cartData.id, cartData.quantity, cartData.properties);
          console.log('[Shopify] Added to Storefront cart:', storefrontCart);
        } else {
          const response = await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cartData)
          });
          if (!response.ok) throw new Error('Failed to add to cart');
          const result = await response.json();
          console.log('[Shopify] Added to AJAX cart:', result);
        }

        // Refresh cart
        const cartResponse = await fetch('/cart.js');
        const cart = await cartResponse.json();

        document.documentElement.dispatchEvent(
          new CustomEvent('cart:refresh', { bubbles: true })
        );

        iframe.contentWindow.postMessage({
          type: 'CART_UPDATED',
          payload: { success: true, cart: cart, storefrontCart: storefrontCart }
        }, '*');

        // Show notification
        var note = document.createElement('div');
        note.style.cssText = 'position:fixed;top:20px;right:20px;background:#000;color:#fff;padding:15px 20px;border-radius:5px;z-index:9999;';
        note.textContent = 'Added to cart!';
        document.body.appendChild(note);
        setTimeout(function() { note.remove(); }, 3000);

        // Redirect to checkout if requested
        if (event.data.checkout) {
          if (storefrontCart && storefrontCart.checkoutUrl) {
            window.location.href = storefrontCart.checkoutUrl;
          } else {
            window.location.href = '/checkout';
          }
        }

      } catch (err) {
        console.error("[Shopify] Cart failed:", err);
        iframe.contentWindow.postMessage({
          type: 'CART_ERROR',
          payload: { success: false, error: err.message }
        }, '*');
      }
    });
  })();
</script>
