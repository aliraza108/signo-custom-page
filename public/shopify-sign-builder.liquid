<!-- Sign Builder Designer - Compact Iframe Version -->
<div class="sign-builder-container" style="margin: 1rem 0;">
  <iframe
    id="designer-iframe"
    src="https://customsigns.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}"
    style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; display: block;"
  ></iframe>
</div>

<style>
  .sign-builder-container {
    background: #f9fafb;
    border-radius: 8px;
  }
  
  #designer-iframe {
    min-height: 600px;
  }
  
  @media (max-width: 768px) {
    #designer-iframe {
      min-height: 500px;
    }
  }
</style>

<script>
  const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dzeolercm/image/upload';
  const CLOUDINARY_UPLOAD_PRESET = 'sign_designs';
  const CLOUDINARY_FOLDER = 'sign-designs';

  async function uploadDesignToCloudinary(dataUrl) {
    if (!dataUrl || typeof dataUrl !== 'string') return null;
    if (!dataUrl.startsWith('data:image/')) return null;
    const blob = await (await fetch(dataUrl)).blob();
    const fd = new FormData();
    fd.append('file', blob, 'design.png');
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    fd.append('folder', CLOUDINARY_FOLDER);
    const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: fd });
    const json = await res.json();
    if (!res.ok || !json.secure_url) {
      throw new Error((json && json.error && json.error.message) || 'Design image upload failed');
    }
    return json.secure_url;
  }

  async function resolveDesignImageUrl(data) {
    if (typeof data.designImageUrl === 'string' && /^https?:\/\//i.test(data.designImageUrl)) return data.designImageUrl;
    if (typeof data.imageUrl === 'string' && /^https?:\/\//i.test(data.imageUrl)) return data.imageUrl;
    if (typeof data.customImage === 'string' && data.customImage.startsWith('data:image/')) {
      return await uploadDesignToCloudinary(data.customImage);
    }
    return null;
  }

  // Pass product data to iframe with retries
  function sendProductDataToIframe() {
    const iframe = document.getElementById('designer-iframe');
    if (!iframe) {
      console.warn('Sign builder iframe not found');
      return;
    }
    
    // Prepare product data with all metafields
    const productData = {
      id: {{ product.id | json }},
      title: {{ product.title | json }},
      handle: {{ product.handle | json }},
      selected_or_first_available_variant: {
        id: {{ product.selected_or_first_available_variant.id | json }},
        price: {{ product.selected_or_first_available_variant.price | json }},
      },
      metafields: {{ product.metafields | json }},
      images: {{ product.images | map: 'src' | json }}
    };
    
    console.log('[Shopify] Sending product data to iframe:', productData);
    
    // Send product data to iframe
    try {
      iframe.contentWindow.postMessage({
        type: 'SHOPIFY_PRODUCT_DATA',
        product: productData
      }, '*');
      console.log('[Shopify] Product data sent successfully');
    } catch (e) {
      console.error('[Shopify] Error sending product data to iframe:', e);
    }
  }
  
  // Send data immediately when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', sendProductDataToIframe);
  } else {
    sendProductDataToIframe();
  }
  
  // Also send on window load and retry a few times
  window.addEventListener('load', () => {
    sendProductDataToIframe();
    // Retry after a short delay
    setTimeout(() => {
      sendProductDataToIframe();
    }, 100);
    setTimeout(() => {
      sendProductDataToIframe();
    }, 500);
  });
  
  // Dynamically resize iframe to fit content
  function resizeSignBuilderIframe() {
    const iframe = document.getElementById('designer-iframe');
    if (!iframe) return;
    
    try {
      const iframeContent = iframe.contentDocument || iframe.contentWindow?.document;
      if (iframeContent) {
        const height = iframeContent.documentElement.scrollHeight;
        iframe.style.height = (height + 20) + 'px';
      }
    } catch (e) {
      // Cross-origin, use message passing or keep default height
    }
  }
  
  // Resize on load and periodically
  document.addEventListener('DOMContentLoaded', resizeSignBuilderIframe);
  window.addEventListener('load', resizeSignBuilderIframe);
  
  // Listen for messages from iframe
  window.addEventListener('message', (event) => {
    if (!event.data) return;

    if (event.data.type === 'RESIZE_IFRAME') {
      const iframe = document.getElementById('designer-iframe');
      if (iframe) {
        iframe.style.height = (event.data.height + 20) + 'px';
      }
    }

    /* ========= RECEIVE ADD TO CART ========= */
    if (event.data.type === 'ADD_TO_CART') {
      (async function() {
        const iframe = document.getElementById('designer-iframe');
        try {
          const imageUrl = await resolveDesignImageUrl(event.data);
          if (!imageUrl) {
            throw new Error('No design image URL available');
          }

          const rawPrice = event.data.price != null ? event.data.price : event.data.unitPrice;
          const props = {};
          if (event.data.material) props['Material'] = event.data.material;
          if (event.data.size) props['Size'] = event.data.size;
          if (event.data.sides) props['Sides'] = event.data.sides;
          if (event.data.qty != null) props['Quantity'] = String(event.data.qty);
          if (rawPrice != null && rawPrice !== '') props['Price'] = '$' + Number(rawPrice).toFixed(2);
          props['Design Image'] = imageUrl;

          const cartData = {
            id: event.data.variantId,
            quantity: event.data.quantity || 1,
            properties: props
          };

          const response = await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cartData)
          });

          if (!response.ok) throw new Error('Failed to add to cart');

          const result = await response.json();
          console.log('[Shopify] Added to cart:', result);

          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();

          document.documentElement.dispatchEvent(
            new CustomEvent('cart:refresh', { bubbles: true })
          );

          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({
              type: 'CART_UPDATED',
              payload: { success: true, cart: cart, imageUrl: imageUrl }
            }, '*');
          }

          if (event.data.checkout) {
            window.location.href = '/checkout';
          }

        } catch (err) {
          console.error("[Shopify] Cart failed:", err);
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({
              type: 'CART_ERROR',
              payload: { success: false, error: err.message }
            }, '*');
          }
        }
      })();
    }
  });
</script>
