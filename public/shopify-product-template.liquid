{% layout none %}

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  /* Hide Shopify footer */
  footer,
  .shopify-section-footer,
  #shopify-section-footer {
    display: none !important;
  }

  #designer-iframe {
    display: block;
    width: 100%;
    height: 100vh;
    border: 0;
    background: white;
  }

  body {
    background: white;
    overflow: hidden;
  }
</style>

<iframe
  id="designer-iframe"
  src="https://customsigns.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}&store={{ shop.myshopify_domain }}">
</iframe>

<script>
(function() {
  'use strict';
  const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dzeolercm/image/upload';
  const CLOUDINARY_UPLOAD_PRESET = 'sign_designs';
  const CLOUDINARY_FOLDER = 'sign-designs';
  
  const iframe = document.getElementById('designer-iframe');
  
  function sendProductData() {
    if (!iframe || !iframe.contentWindow) {
      console.log('[Shopify] Iframe not ready');
      return;
    }

    try {
      const productData = {
        id: {{ product.id | json }},
        title: {{ product.title | json }},
        handle: {{ product.handle | json }},
        store: {{ shop.myshopify_domain | json }},
        variant: {
          id: {{ product.selected_or_first_available_variant.id | json }},
          price: {{ product.selected_or_first_available_variant.price | json }},
          sku: {{ product.selected_or_first_available_variant.sku | json }}
        },
        metafields: {{ product.metafields.custom | json }}
      };

      console.log('[Shopify] Sending product data:', productData);

      iframe.contentWindow.postMessage({
        type: 'SHOPIFY_PRODUCT_DATA',
        payload: productData
      }, '*');
    } catch (error) {
      console.error('[Shopify] Error sending data:', error);
    }
  }

  // Send data when iframe loads
  if (iframe.contentWindow) {
    // Already loaded
    sendProductData();
  }

  iframe.addEventListener('load', function() {
    console.log('[Shopify] Iframe loaded');
    sendProductData();
    setTimeout(sendProductData, 300);
    setTimeout(sendProductData, 800);
  });

  // Fallback - send after delays
  setTimeout(sendProductData, 100);
  setTimeout(sendProductData, 1000);

  // Listen for cart messages from iframe
  window.addEventListener('message', function(event) {
    console.log('[Shopify] Message received:', event.data.type);
    
    if (event.data.type === 'ADD_TO_CART') {
      console.log('[Shopify] Cart message data:', event.data);
      addToCart(event.data).catch(function(error) {
        console.error('[Shopify] Cart error:', error);
        iframe.contentWindow.postMessage({
          type: 'CART_ERROR',
          payload: { success: false, error: error.message || 'Failed to add to cart' }
        }, '*');
      });
    }
  });

  async function uploadDesignToCloudinary(dataUrl) {
    if (!dataUrl || typeof dataUrl !== 'string') return null;
    if (!dataUrl.startsWith('data:image/')) return null;
    const blob = await (await fetch(dataUrl)).blob();
    const fd = new FormData();
    fd.append('file', blob, 'design.png');
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    fd.append('folder', CLOUDINARY_FOLDER);
    const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: fd });
    const json = await res.json();
    if (!res.ok || !json.secure_url) {
      throw new Error((json && json.error && json.error.message) || 'Design image upload failed');
    }
    return json.secure_url;
  }

  async function resolveDesignImageUrl(data) {
    if (typeof data.designImageUrl === 'string' && /^https?:\/\//i.test(data.designImageUrl)) return data.designImageUrl;
    if (typeof data.imageUrl === 'string' && /^https?:\/\//i.test(data.imageUrl)) return data.imageUrl;
    if (typeof data.customImage === 'string' && data.customImage.startsWith('data:image/')) {
      return await uploadDesignToCloudinary(data.customImage);
    }
    return null;
  }

  // Add to cart function using Shopify Cart API
  async function addToCart(data) {
    const variantId = data.variantId;
    const quantity = data.quantity || 1;
    const checkout = !!data.checkout;
    const imageUrl = await resolveDesignImageUrl(data);
    if (!imageUrl) {
      throw new Error('No design image URL available');
    }

    const properties = {};
    if (data.material) properties['Material'] = data.material;
    if (data.size) properties['Size'] = data.size;
    if (data.sides) properties['Sides'] = data.sides;
    if (data.qty != null) properties['Quantity'] = String(data.qty);
    properties['Design Image'] = imageUrl;
    properties['_Design Image URL'] = imageUrl;

    console.log('[Shopify] Adding to cart with:', { variantId, quantity, properties, checkout });

    fetch({{ shop.cart_add_url | json }}, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        id: variantId,
        quantity: quantity,
        properties: properties
      })
    })
    .then(response => {
      console.log('[Shopify] Cart response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('[Shopify] Cart add success:', data);
      
      iframe.contentWindow.postMessage({
        type: 'CART_UPDATED',
        payload: { success: true, imageUrl: imageUrl, itemKey: data.key }
      }, '*');
      
      // Only redirect to checkout if explicitly requested
      if (checkout) {
        window.location.href = {{ shop.checkout_url | json }};
      }
      // Otherwise just stay on the page - cart is updated via AJAX
    })
    .catch(error => {
      console.error('[Shopify] Cart error:', error);
      iframe.contentWindow.postMessage({
        type: 'CART_ERROR',
        payload: { success: false, error: error.message }
      }, '*');
    });
  }
})();
</script>
