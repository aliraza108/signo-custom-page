{% layout none %}

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  /* Hide Shopify footer */
  footer,
  .shopify-section-footer,
  #shopify-section-footer {
    display: none !important;
  }

  #designer-iframe {
    display: block;
    width: 100%;
    height: 100vh;
    border: 0;
    background: white;
  }

  body {
    background: white;
    overflow: hidden;
  }
</style>

<iframe
  id="designer-iframe"
  src="https://customsigns.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}&store={{ shop.myshopify_domain }}">
</iframe>

<script>
(function() {
  'use strict';
  const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dzeolercm/image/upload';
  const CLOUDINARY_UPLOAD_PRESET = 'sign_designs';
  const CLOUDINARY_FOLDER = 'sign-designs';
  const STOREFRONT_API_VERSION = '2025-01';
  const STOREFRONT_API_TOKEN = {{ settings.storefront_api_token | default: '' | json }};
  const STOREFRONT_API_URL = '/api/' + STOREFRONT_API_VERSION + '/graphql.json';
  const STOREFRONT_CART_ID_KEY = 'signo_storefront_cart_id';
  
  const iframe = document.getElementById('designer-iframe');
  
  function sendProductData() {
    if (!iframe || !iframe.contentWindow) {
      console.log('[Shopify] Iframe not ready');
      return;
    }

    try {
      const productData = {
        id: {{ product.id | json }},
        title: {{ product.title | json }},
        handle: {{ product.handle | json }},
        store: {{ shop.myshopify_domain | json }},
        variant: {
          id: {{ product.selected_or_first_available_variant.id | json }},
          price: {{ product.selected_or_first_available_variant.price | json }},
          sku: {{ product.selected_or_first_available_variant.sku | json }}
        },
        metafields: {{ product.metafields.custom | json }}
      };

      console.log('[Shopify] Sending product data:', productData);

      iframe.contentWindow.postMessage({
        type: 'SHOPIFY_PRODUCT_DATA',
        payload: productData
      }, '*');
    } catch (error) {
      console.error('[Shopify] Error sending data:', error);
    }
  }

  // Send data when iframe loads
  if (iframe.contentWindow) {
    // Already loaded
    sendProductData();
  }

  iframe.addEventListener('load', function() {
    console.log('[Shopify] Iframe loaded');
    sendProductData();
    setTimeout(sendProductData, 300);
    setTimeout(sendProductData, 800);
  });

  // Fallback - send after delays
  setTimeout(sendProductData, 100);
  setTimeout(sendProductData, 1000);

  // Listen for cart messages from iframe
  window.addEventListener('message', function(event) {
    console.log('[Shopify] Message received:', event.data.type);
    
    if (event.data.type === 'ADD_TO_CART') {
      console.log('[Shopify] Cart message data:', event.data);
      addToCart(event.data).catch(function(error) {
        console.error('[Shopify] Cart error:', error);
        iframe.contentWindow.postMessage({
          type: 'CART_ERROR',
          payload: { success: false, error: error.message || 'Failed to add to cart' }
        }, '*');
      });
    }
  });

  async function uploadDesignToCloudinary(dataUrl) {
    if (!dataUrl || typeof dataUrl !== 'string') return null;
    if (!dataUrl.startsWith('data:image/')) return null;
    const blob = await (await fetch(dataUrl)).blob();
    const fd = new FormData();
    fd.append('file', blob, 'design.png');
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    fd.append('folder', CLOUDINARY_FOLDER);
    const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: fd });
    const json = await res.json();
    if (!res.ok || !json.secure_url) {
      throw new Error((json && json.error && json.error.message) || 'Design image upload failed');
    }
    return json.secure_url;
  }

  async function resolveDesignImageUrl(data) {
    if (typeof data.designImageUrl === 'string' && /^https?:\/\//i.test(data.designImageUrl)) return data.designImageUrl;
    if (typeof data.imageUrl === 'string' && /^https?:\/\//i.test(data.imageUrl)) return data.imageUrl;
    if (typeof data.customImage === 'string' && data.customImage.startsWith('data:image/')) {
      return await uploadDesignToCloudinary(data.customImage);
    }
    return null;
  }

  function toVariantGid(variantId) {
    const raw = String(variantId || '').trim();
    if (!raw) return '';
    if (raw.indexOf('gid://shopify/ProductVariant/') === 0) return raw;
    const idPart = raw.split('/').pop();
    return idPart ? ('gid://shopify/ProductVariant/' + idPart) : '';
  }

  function getStoredCartId() {
    try {
      return window.localStorage.getItem(STOREFRONT_CART_ID_KEY) || '';
    } catch (e) {
      return '';
    }
  }

  function setStoredCartId(cartId) {
    if (!cartId) return;
    try {
      window.localStorage.setItem(STOREFRONT_CART_ID_KEY, cartId);
    } catch (e) {}
  }

  function hasStorefrontToken() {
    return typeof STOREFRONT_API_TOKEN === 'string' && STOREFRONT_API_TOKEN.length > 0;
  }

  async function storefrontRequest(query, variables) {
    const res = await fetch(STOREFRONT_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Storefront-Access-Token': STOREFRONT_API_TOKEN
      },
      body: JSON.stringify({ query, variables })
    });
    const json = await res.json();
    if (!res.ok || json.errors) {
      throw new Error((json && json.errors && json.errors[0] && json.errors[0].message) || 'Storefront API request failed');
    }
    return json.data || {};
  }

  function toLineAttributes(props) {
    return Object.keys(props || {}).map(function(key) {
      return { key: String(key), value: String(props[key]) };
    });
  }

  async function addToStorefrontCart(variantId, quantity, props) {
    const merchandiseId = toVariantGid(variantId);
    if (!merchandiseId) {
      throw new Error('Invalid variant ID for Storefront API');
    }

    const attributes = toLineAttributes(props);
    const cartId = getStoredCartId();

    if (cartId) {
      const addLineMutation = `
        mutation cartLinesAdd($cartId: ID!, $lines: [CartLineInput!]!) {
          cartLinesAdd(cartId: $cartId, lines: $lines) {
            cart {
              id
              checkoutUrl
            }
            userErrors {
              field
              message
            }
          }
        }
      `;
      const addData = await storefrontRequest(addLineMutation, {
        cartId: cartId,
        lines: [{ merchandiseId: merchandiseId, quantity: quantity, attributes: attributes }]
      });
      const addResult = addData.cartLinesAdd;
      if (addResult && addResult.userErrors && addResult.userErrors.length > 0) {
        throw new Error(addResult.userErrors[0].message || 'Unable to add line to existing cart');
      }
      if (addResult && addResult.cart && addResult.cart.id) {
        setStoredCartId(addResult.cart.id);
      }
      return addResult ? addResult.cart : null;
    }

    const createMutation = `
      mutation cartCreate($input: CartInput!) {
        cartCreate(input: $input) {
          cart {
            id
            checkoutUrl
          }
          userErrors {
            field
            message
          }
        }
      }
    `;
    const createData = await storefrontRequest(createMutation, {
      input: {
        lines: [{ merchandiseId: merchandiseId, quantity: quantity, attributes: attributes }]
      }
    });
    const createResult = createData.cartCreate;
    if (createResult && createResult.userErrors && createResult.userErrors.length > 0) {
      throw new Error(createResult.userErrors[0].message || 'Unable to create Storefront cart');
    }
    if (createResult && createResult.cart && createResult.cart.id) {
      setStoredCartId(createResult.cart.id);
    }
    return createResult ? createResult.cart : null;
  }

  // Add to cart function using Shopify Cart API
  async function addToCart(data) {
    const variantId = data.variantId;
    const quantity = data.quantity || 1;
    const checkout = !!data.checkout;
    const imageUrl = await resolveDesignImageUrl(data);
    if (!imageUrl) {
      throw new Error('No design image URL available');
    }

    const properties = {};
    const rawPrice = data.price != null ? data.price : data.unitPrice;
    if (data.material) properties['Material'] = data.material;
    if (data.size) properties['Size'] = data.size;
    if (data.sides) properties['Sides'] = data.sides;
    if (data.qty != null) properties['Quantity'] = String(data.qty);
    if (rawPrice != null && rawPrice !== '') properties['Price'] = '$' + Number(rawPrice).toFixed(2);
    properties['Design Image'] = imageUrl;
    properties['_Design Image URL'] = imageUrl;

    console.log('[Shopify] Adding to cart with:', { variantId, quantity, properties, checkout });

    Promise.resolve()
    .then(async () => {
      if (hasStorefrontToken()) {
        const storefrontCart = await addToStorefrontCart(variantId, quantity, properties);
        return { storefrontCart: storefrontCart, data: null };
      }
      const response = await fetch({{ shop.cart_add_url | json }}, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity,
          properties: properties
        })
      });
      console.log('[Shopify] Cart response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      return { storefrontCart: null, data: data };
    })
    .then(({ storefrontCart, data }) => {
      console.log('[Shopify] Cart add success:', { storefrontCart, data });

      iframe.contentWindow.postMessage({
        type: 'CART_UPDATED',
        payload: {
          success: true,
          imageUrl: imageUrl,
          itemKey: data && data.key ? data.key : null,
          storefrontCart: storefrontCart
        }
      }, '*');
      
      if (checkout) {
        if (storefrontCart && storefrontCart.checkoutUrl) {
          window.location.href = storefrontCart.checkoutUrl;
        } else {
          window.location.href = {{ shop.checkout_url | json }};
        }
      }
    })
    .catch(error => {
      console.error('[Shopify] Cart error:', error);
      iframe.contentWindow.postMessage({
        type: 'CART_ERROR',
        payload: { success: false, error: error.message }
      }, '*');
    });
  }
})();
</script>
