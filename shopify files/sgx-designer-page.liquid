{% comment %}
  SignoGrafx – Custom Designer Page  (v4 FINAL)
  ──────────────────────────────────────────────
  ✅ NO popup on add to cart — cart count just updates in header
  ✅ Composite image (SVGs + icons + layers) → Cloudinary → CDN URL in cart
  ✅ Cart properties match product page exactly:
       Material, Size, Sides, Quantity, Price Per Unit, Design Image (URL)
  ✅ Metafields sent to designer iframe (sizes, materials, price_per_sqft)
  ✅ Cart count instant update
{% endcomment %}

<style>
html,body{margin:0;padding:0}
footer,.shopify-section-footer,#shopify-section-footer{display:none !important}
#designer-iframe{display:block;width:100%;height:calc(100vh - 80px);min-height:600px;border:0}

/* Loading */
#sgxLoad{position:fixed;inset:0;z-index:9998;background:rgba(255,255,255,.93);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;font-family:Inter,-apple-system,sans-serif;transition:opacity .3s}
#sgxLoad.hidden{opacity:0;pointer-events:none}
.sgx-ring{width:44px;height:44px;border:4px solid #e0e0e0;border-top-color:#0a8ff5;border-radius:50%;animation:sgxSpin 1s linear infinite}
@keyframes sgxSpin{to{transform:rotate(360deg)}}
.sgx-load-text{font-size:13px;color:#666;font-weight:500}

/* Hidden canvas for compositing */
#sgxCanvas{position:fixed;left:-9999px;top:0;pointer-events:none}
</style>

<div id="sgxLoad">
  <div class="sgx-ring"></div>
  <div class="sgx-load-text">Loading designer…</div>
</div>

<iframe id="designer-iframe"
  src="https://v0-cloudinary-api-keys.vercel.app/?product={{ product.id }}&variant={{ product.selected_or_first_available_variant.id }}"
  allow="camera;clipboard-write">
</iframe>

<canvas id="sgxCanvas"></canvas>

<!-- Metafields for designer -->
<script id="sgxMfRaw" type="application/json">{{ product.metafields.custom | json }}</script>

<script>
(function(){
'use strict';

const CLOUDINARY_CLOUD  = 'dzeolercm';
const CLOUDINARY_PRESET = 'sign_designs';

const iframe  = document.getElementById('designer-iframe');
const loader  = document.getElementById('sgxLoad');
const canvas  = document.getElementById('sgxCanvas');
const ctx     = canvas.getContext('2d');

/* ═══ METAFIELDS ═══ */
let MF = {};
try{ MF = JSON.parse(document.getElementById('sgxMfRaw').textContent)||{}; }catch(e){}
function parseMfJson(v){
  if(!v||v==='null'||v==='') return null;
  if(typeof v==='object') return v;
  try{
    var first=JSON.parse(v);
    if(typeof first==='string'){
      try{return JSON.parse(first);}catch(e){return first;}
    }
    return first;
  }catch(e){return null;}
}

/* ═══ HIDE LOADER ═══ */
iframe.addEventListener('load',function(){
  setTimeout(()=>{ if(loader){loader.classList.add('hidden');setTimeout(()=>loader.remove(),400);} },700);
  sendProductData();
  setTimeout(sendProductData,600);
  setTimeout(sendProductData,1400);
});

/* ═══ SEND PRODUCT DATA ═══ */
function sendProductData(){
  if(!iframe||!iframe.contentWindow) return;
  iframe.contentWindow.postMessage({
    type:'SHOPIFY_PRODUCT_DATA',
    payload:{
      id:        {{ product.id | json }},
      title:     {{ product.title | json }},
      handle:    {{ product.handle | json }},
      variant:{
        id:      {{ product.selected_or_first_available_variant.id | json }},
        price:   {{ product.selected_or_first_available_variant.price | json }} / 100
      },
      /* Pass parsed metafields so designer can show size/material options */
      metafields: MF,
      sizes:      Array.isArray(parseMfJson(MF.sizes)) ? parseMfJson(MF.sizes) : [],
      materials:  Array.isArray(parseMfJson(MF.materials)) ? parseMfJson(MF.materials) : [],
      price_per_sqft: MF.price_per_sqft || null,
      all_metafields: MF
    }
  },'*');
}

/* ═══════════════════════════════════════
   IMAGE COMPOSITING
   Merges all layers (SVG + bitmap) into
   a single PNG canvas export
═══════════════════════════════════════ */
function rasteriseSvg(svgStr,w,h){
  return new Promise(function(resolve){
    var tmp=document.createElement('canvas');
    tmp.width=w||1200; tmp.height=h||1200;
    var c=tmp.getContext('2d');
    var svg=svgStr.trim();
    if(svg.indexOf('xmlns')===-1) svg=svg.replace('<svg','<svg xmlns="http://www.w3.org/2000/svg"');
    if(!/\bwidth\s*=/.test(svg.substring(0,400)))
      svg=svg.replace(/(<svg[^>]*)>/,'$1 width="'+tmp.width+'" height="'+tmp.height+'">');
    var blob=new Blob([svg],{type:'image/svg+xml;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var img=new Image();
    img.onload=function(){c.drawImage(img,0,0,tmp.width,tmp.height);URL.revokeObjectURL(url);resolve(tmp.toDataURL('image/png',1));};
    img.onerror=function(){URL.revokeObjectURL(url);resolve(tmp.toDataURL('image/png',1));};
    img.src=url;
  });
}

function loadImg(src){
  return new Promise(function(resolve){
    var img=new Image();
    img.crossOrigin='anonymous';
    img.onload=function(){resolve(img);};
    img.onerror=function(){resolve(null);};
    img.src=src;
  });
}

async function compositeLayers(layers,W,H){
  canvas.width=W||1200; canvas.height=H||1200;
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(var i=0;i<layers.length;i++){
    var layer=layers[i]; if(!layer) continue;
    var x=layer.x||0, y=layer.y||0;
    var w=layer.width||canvas.width, h=layer.height||canvas.height;
    var op=layer.opacity!=null?layer.opacity:1;
    var rot=layer.rotation||0;
    ctx.save(); ctx.globalAlpha=Math.max(0,Math.min(1,op));
    if(rot){ctx.translate(x+w/2,y+h/2);ctx.rotate(rot*Math.PI/180);ctx.translate(-(x+w/2),-(y+h/2));}
    try{
      var src=layer.svgString ? await rasteriseSvg(layer.svgString,w,h) : layer.dataUrl;
      if(src){var imgEl=await loadImg(src);if(imgEl)ctx.drawImage(imgEl,x,y,w,h);}
    }catch(e){console.warn('[SGX] layer err',e.message);}
    ctx.restore();
  }
  return canvas.toDataURL('image/png',1.0);
}

async function resolveImage(data){
  var W=data.canvasWidth||1200, H=data.canvasHeight||1200;
  if(data.layerData&&data.layerData.length>0) return await compositeLayers(data.layerData,W,H);
  if(data.svgString) return await rasteriseSvg(data.svgString,W,H);
  if(data.customImage) return data.customImage;
  return null;
}

/* ═══════════════════════════════════════
   UPLOAD TO CLOUDINARY
═══════════════════════════════════════ */
async function uploadToCloudinary(dataUrl){
  /* Convert data URL to blob */
  var arr=dataUrl.split(','), mime=arr[0].match(/:(.*?);/)[1];
  var bstr=atob(arr[1]), n=bstr.length, u8=new Uint8Array(n);
  for(var i=0;i<n;i++) u8[i]=bstr.charCodeAt(i);
  var blob=new Blob([u8],{type:mime});

  var fd=new FormData();
  fd.append('file',blob,'design.png');
  fd.append('upload_preset',CLOUDINARY_PRESET);
  fd.append('folder','sign-designs');

  var res=await fetch('https://api.cloudinary.com/v1_1/'+CLOUDINARY_CLOUD+'/image/upload',{method:'POST',body:fd});
  var json=await res.json();
  if(!json.secure_url) throw new Error(json.error?.message||'Cloudinary upload failed');
  return json.secure_url;
}

/* ═══════════════════════════════════════
   REFRESH CART COUNT (instant)
═══════════════════════════════════════ */
function refreshCartCount(){
  fetch('/cart.js').then(r=>r.json()).then(cart=>{
    var count=cart.item_count;
    [
      '[data-cart-count]','[data-cart-item-count]','[data-cart-icon-bubble]',
      '[data-cart-badge]','.cart-count','.cart__count','.cart-count-bubble',
      '#CartCount','.js-cart-count','[data-header-cart-quantity]'
    ].forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        el.textContent=count;
        el.setAttribute('data-count',count);
      });
    });
    ['cart:refresh','cart:updated','cart:change'].forEach(function(evName){
      document.documentElement.dispatchEvent(new CustomEvent(evName,{bubbles:true,detail:cart}));
    });
    if(window.theme&&window.theme.cart&&window.theme.cart.getCart) window.theme.cart.getCart();
    if(window.theme&&window.theme.miniCart&&window.theme.miniCart.refresh) window.theme.miniCart.refresh();
    if(window.Shopify&&window.Shopify.onCartUpdate) window.Shopify.onCartUpdate(cart);
  });
}

/* ═══════════════════════════════════════
   MESSAGE HANDLER
═══════════════════════════════════════ */
window.addEventListener('message',async function(ev){
  if(!ev.data||!ev.data.type) return;

  /* ─── ADD_TO_CART ─── */
  if(ev.data.type==='ADD_TO_CART'){
    var data=ev.data;

    /* Notify designer we're processing */
    iframe.contentWindow.postMessage({type:'CART_PROCESSING'},'*');

    try{
      /* 1. Composite all layers into one PNG */
      var compositeDataUrl = await resolveImage(data);

      /* 2. Upload composite to Cloudinary → get CDN URL */
      var imageUrl = null;
      if(compositeDataUrl){
        imageUrl = await uploadToCloudinary(compositeDataUrl);
      }

      /* 3. Build cart properties — same keys as product page */
      var props = {};
      if(data.material)             props['Material']       = data.material;
      if(data.size||data.customSize)props['Size']           = data.size||data.customSize;
      if(data.sides)                props['Sides']          = data.sides;
      if(data.qty)                  props['Quantity']       = String(data.qty);
      if(data.unitPrice)            props['Price Per Unit'] = '$'+parseFloat(data.unitPrice).toFixed(2);
      /* ONE image property — Cloudinary URL */
      if(imageUrl)                  props['Design Image']   = imageUrl;
      /* Remove any duplicates the designer app may have added */
      delete props['Custom Image'];
      delete props['_customImage'];
      delete props['_image'];
      delete props['custom_image'];
      delete props['design_image'];
      delete props['customImage'];

      /* 4. Add to Shopify cart */
      var res=await fetch('/cart/add.js',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id:data.variantId,quantity:data.quantity||1,properties:props})
      });
      if(!res.ok){var eb=await res.json().catch(()=>({}));throw new Error(eb.description||'Cart error');}
      var result=await res.json();

      /* 5. Instant cart count update — NO popup */
      refreshCartCount();

      /* 6. Tell designer success with image URL */
      iframe.contentWindow.postMessage({
        type:'CART_UPDATED',
        payload:{success:true,imageUrl:imageUrl,itemKey:result.key}
      },'*');

    }catch(err){
      console.error('[SGX] ATC failed:',err);
      iframe.contentWindow.postMessage({type:'CART_ERROR',payload:{success:false,error:err.message}},'*');
    }
  }

  /* ─── REQUEST_COMPOSITE_IMAGE ─── */
  if(ev.data.type==='REQUEST_COMPOSITE_IMAGE'){
    try{
      var url=await compositeLayers(ev.data.layers||[],ev.data.width||1200,ev.data.height||1200);
      /* Optionally upload to Cloudinary if requested */
      var cdnUrl=null;
      if(ev.data.uploadToCloud) cdnUrl=await uploadToCloudinary(url);
      iframe.contentWindow.postMessage({
        type:'COMPOSITE_IMAGE_RESULT',
        payload:{success:true,dataUrl:url,cloudinaryUrl:cdnUrl}
      },'*');
    }catch(e){
      iframe.contentWindow.postMessage({type:'COMPOSITE_IMAGE_RESULT',payload:{success:false,error:e.message}},'*');
    }
  }

});

})();
</script>
