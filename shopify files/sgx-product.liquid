{% comment %}
  SignoGrafx ‚Äì Product Page  (v4 FINAL)
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚úÖ Size: W√óH inputs + preset buttons from metafield sizes(JSON) or defaults
  ‚úÖ Material: from metafield materials(JSON) or variant option
  ‚úÖ price_per_sqft metafield shown + area calc
  ‚úÖ All metafields (sizes/materials/price_per_sqft/custom) shown as cards & specs table
  ‚úÖ Upload ‚Üí Cloudinary first ‚Üí CDN URL stored in cart (not base64)
  ‚úÖ Uploaded image replaces preview; old removed; shown in Order Summary
  ‚úÖ Single cart property "Design Image" = CDN URL (no duplicates)
  ‚úÖ Instant cart count update on Add to Cart
  ‚úÖ Sides selector
{% endcomment %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
.sgx-pg*,.sgx-pg *::before,.sgx-pg *::after{box-sizing:border-box;margin:0;padding:0}
.sgx-pg{font-family:'Inter',-apple-system,sans-serif;color:#1a1a1a;background:#fff}
.sgx-breadcrumb{font-size:12px;color:#666;padding:10px 0 20px}
.sgx-breadcrumb a{color:#0a8ff5;text-decoration:none}
.sgx-breadcrumb a:hover{text-decoration:underline}
.sgx-breadcrumb span{color:#999}
.sgx-product-wrap{max-width:1200px;margin:0 auto;padding:0 20px 60px}
.sgx-product-cols{display:grid;grid-template-columns:1fr 1fr;gap:48px;align-items:start}
@media(max-width:768px){.sgx-product-cols{grid-template-columns:1fr;gap:24px}}

/* gallery */
.sgx-main-img-wrap{width:100%;aspect-ratio:1;background:#f5f5f5;display:flex;align-items:center;justify-content:center;border:1px solid #e8e8e8;overflow:hidden;margin-bottom:12px;position:relative;border-radius:8px}
.sgx-main-img-wrap img{max-width:100%;max-height:100%;object-fit:contain;transition:opacity .2s}
.sgx-custom-badge{position:absolute;top:10px;left:10px;background:#0a8ff5;color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;display:none}
.sgx-thumbs{display:flex;gap:8px;flex-wrap:wrap}
.sgx-thumb{width:72px;height:58px;border:2px solid #e0e0e0;cursor:pointer;overflow:hidden;background:#f9f9f9;display:flex;align-items:center;justify-content:center;transition:border-color .2s;border-radius:4px;flex-shrink:0}
.sgx-thumb:hover,.sgx-thumb.active{border-color:#0a8ff5}
.sgx-thumb img{max-width:100%;max-height:100%;object-fit:contain}
.sgx-thumb-upload.active{border-color:#4caf78 !important}

/* info */
.sgx-info{display:flex;flex-direction:column;gap:13px}
.sgx-title{font-size:24px;font-weight:700;line-height:1.3;color:#111}
.sgx-price-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.sgx-price-sale{font-size:22px;font-weight:700;color:#111}
.sgx-price-compare{font-size:16px;color:#999;text-decoration:line-through}
.sgx-sale-badge{background:#e8414b;color:#fff;font-size:11px;font-weight:700;padding:2px 7px;border-radius:3px;text-transform:uppercase}
.sgx-shoppay{font-size:13px;color:#555}
.sgx-shoppay a{color:#5a31f4;text-decoration:none;font-weight:500}
.sgx-divider{height:1px;background:#f0f0f0;margin:4px 0}

/* labels */
.sgx-label{font-size:13px;font-weight:600;color:#333;margin-bottom:7px;display:block}
.sgx-label span{font-weight:400;color:#777}

/* pills */
.sgx-pills{display:flex;gap:7px;flex-wrap:wrap}
.sgx-pill{padding:6px 15px;border:1.5px solid #ccc;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;background:#fff;color:#333;transition:all .15s;font-family:inherit}
.sgx-pill:hover{border-color:#0a8ff5;color:#0a8ff5}
.sgx-pill.active{border-color:#111;background:#111;color:#fff;font-weight:600}

/* size section */
.sgx-size-section{background:#f8fbff;border:1.5px solid #c5dff8;border-radius:10px;padding:14px 16px}
.sgx-size-presets{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.sgx-preset-btn{padding:5px 12px;border:1.5px solid #c5dff8;border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;color:#1a5276;transition:all .15s;font-family:inherit;white-space:nowrap}
.sgx-preset-btn:hover{border-color:#0a8ff5;background:#e8f4fd;color:#0a8ff5}
.sgx-preset-btn.active{border-color:#0a8ff5;background:#0a8ff5;color:#fff}
.sgx-size-inputs{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.sgx-size-inputs label{font-size:12px;color:#555;font-weight:600}
.sgx-dim-input{width:72px;padding:8px 10px;border:1.5px solid #ccc;border-radius:6px;font-size:13px;font-family:inherit;color:#111;transition:border-color .2s}
.sgx-dim-input:focus{outline:none;border-color:#0a8ff5}
.sgx-size-x{font-size:15px;color:#999;font-weight:700}
.sgx-dim-unit{padding:8px 10px;border:1.5px solid #ccc;border-radius:6px;font-size:13px;font-family:inherit;background:#fff;cursor:pointer}
.sgx-size-note{font-size:11px;color:#888;margin-top:8px;font-style:italic}

/* sides */
.sgx-sides-wrap{background:#fffbf0;border:1.5px solid #f0d060;border-radius:8px;padding:12px 14px}
.sgx-sides-row{display:flex;gap:10px;margin-top:8px}
.sgx-side-card{flex:1;border:2px solid #e0e0e0;border-radius:8px;padding:10px 12px;cursor:pointer;background:#fff;transition:all .2s;text-align:center}
.sgx-side-card:hover{border-color:#0a8ff5}
.sgx-side-card.active{border-color:#0a8ff5;background:#f0f8ff}
.sgx-side-card .s-icon{font-size:18px;margin-bottom:3px}
.sgx-side-card .s-label{font-size:12px;font-weight:700;color:#222}
.sgx-side-card .s-desc{font-size:11px;color:#888;margin-top:1px}

/* upload */
.sgx-upload-wrap{background:#f8fff8;border:1.5px dashed #4caf78;border-radius:8px;padding:13px 15px}
.sgx-upload-head{font-size:13px;font-weight:600;color:#1a4a2c;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sgx-upload-zone{position:relative;cursor:pointer;border:2px dashed #cde8d5;border-radius:6px;padding:16px;text-align:center;background:#f0faf4;transition:border-color .2s,background .2s}
.sgx-upload-zone:hover,.sgx-upload-zone.drag-over{border-color:#4caf78;background:#e4f5ec}
.sgx-upload-zone input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;z-index:2}
.sgx-upload-icon{font-size:24px;margin-bottom:4px}
.sgx-upload-zone p{font-size:12px;color:#555;margin:0;pointer-events:none}
.sgx-upload-zone p strong{color:#2e7d4f}
.sgx-upload-progress{display:none;margin-top:8px;background:#e8f7ef;border-radius:6px;padding:8px 12px;align-items:center;gap:8px}
.sgx-upload-progress.visible{display:flex}
.sgx-up-spinner{width:16px;height:16px;border:2px solid #a8d8bc;border-top-color:#2e7d4f;border-radius:50%;animation:sgxSpin .8s linear infinite;flex-shrink:0}
@keyframes sgxSpin{to{transform:rotate(360deg)}}
.sgx-up-text{font-size:12px;color:#2e7d4f;font-weight:600}
.sgx-upload-preview{display:none;margin-top:8px;align-items:center;gap:10px;background:#e8f7ef;border-radius:6px;padding:8px 10px}
.sgx-upload-preview.visible{display:flex}
.sgx-upload-preview img{width:52px;height:52px;object-fit:cover;border-radius:4px;border:1px solid #a8d8bc;flex-shrink:0}
.sgx-up-info{flex:1;min-width:0}
.sgx-up-info .fn{font-size:12px;font-weight:600;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sgx-up-info .fs{font-size:11px;color:#777;margin-top:1px}
.sgx-up-info .fok{font-size:11px;color:#2e7d4f;margin-top:2px;font-style:italic}
.sgx-upload-remove{background:none;border:none;color:#c00;cursor:pointer;font-size:20px;line-height:1;padding:0 4px;flex-shrink:0}

/* qty */
.sgx-qty-ctrl{display:flex;align-items:center;border:1.5px solid #ccc;border-radius:6px;overflow:hidden;width:fit-content}
.sgx-qty-btn{width:38px;height:40px;background:#f5f5f5;border:none;font-size:20px;cursor:pointer;color:#333;transition:background .15s;display:flex;align-items:center;justify-content:center;font-family:inherit}
.sgx-qty-btn:hover{background:#e0e0e0}
.sgx-qty-val{width:48px;height:40px;border:none;border-left:1.5px solid #ccc;border-right:1.5px solid #ccc;text-align:center;font-size:14px;font-weight:700;color:#111;background:#fff}
.sgx-qty-val:focus{outline:none}

/* summary */
.sgx-summary{background:#f8f9fb;border:1px solid #e3e6ea;border-radius:8px;padding:12px 14px;font-size:13px}
.sgx-summary-title{font-weight:700;color:#333;margin-bottom:8px;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
.sgx-sum-row{display:flex;justify-content:space-between;color:#555;padding:3px 0}
.sgx-sum-row.total{font-weight:700;color:#111;border-top:1px solid #e0e0e0;margin-top:6px;padding-top:8px;font-size:14px}
.sgx-sum-img{display:none;align-items:center;gap:8px;margin-top:6px;padding-top:6px;border-top:1px dashed #e0e0e0}
.sgx-sum-img.visible{display:flex}
.sgx-sum-img img{width:44px;height:44px;object-fit:cover;border-radius:4px;border:1px solid #d0d5dd}
.sgx-sum-img span{font-size:11px;color:#555;font-style:italic}

/* buttons */
.sgx-btn-atc{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;background:#0a8ff5;color:#fff;border:none;border-radius:6px;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;font-family:inherit}
.sgx-btn-atc:hover:not(:disabled){background:#0878d4}
.sgx-btn-atc:disabled{background:#7bbfee;cursor:not-allowed}
.sgx-btn-buy{display:flex;align-items:center;justify-content:center;width:100%;padding:14px 20px;background:#111;color:#fff;border:none;border-radius:6px;font-size:15px;font-weight:700;cursor:pointer;transition:background .2s;font-family:inherit}
.sgx-btn-buy:hover{background:#333}
.sgx-btn-customize{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px 20px;background:transparent;color:#0a8ff5;border:2px solid #0a8ff5;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.sgx-btn-customize:hover{background:#0a8ff5;color:#fff}
.sgx-cart-msg{display:none;padding:11px 14px;border-radius:6px;font-size:13px;font-weight:600;text-align:center}
.sgx-cart-msg.ok{display:block;background:#e8f9f2;color:#18a06b;border:1px solid #18a06b}
.sgx-cart-msg.err{display:block;background:#fef2f2;color:#d42b2b;border:1px solid #d42b2b}
.sgx-social{font-size:13px;color:#555}
.sgx-social strong{color:#e8414b}
.sgx-meta{font-size:13px;color:#555;display:grid;grid-template-columns:110px 1fr;gap:6px 10px}
.sgx-meta strong{color:#333;font-weight:600}

/* tabs */
.sgx-tabs{border-bottom:2px solid #e0e0e0;margin-top:40px}
.sgx-tab-btn{padding:12px 22px;background:none;border:none;border-bottom:3px solid transparent;font-size:14px;font-weight:600;color:#777;cursor:pointer;margin-bottom:-2px;font-family:inherit;transition:all .18s}
.sgx-tab-btn:hover{color:#0a8ff5}
.sgx-tab-btn.active{color:#0a8ff5;border-bottom-color:#0a8ff5}
.sgx-tab-panel{display:none;padding:24px 0}
.sgx-tab-panel.active{display:block}
.sgx-tab-content{font-size:14px;color:#444;line-height:1.85}
.sgx-tab-content p{margin-bottom:12px}
.sgx-tab-content ul,.sgx-tab-content ol{padding-left:22px;margin-bottom:12px}
.sgx-mf-section{margin-top:28px}
.sgx-mf-section h3{font-size:15px;font-weight:700;color:#111;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #f0f0f0}
.sgx-mf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px}
.sgx-mf-card{background:#f8f9fb;border:1px solid #e3e6ea;border-radius:8px;padding:11px 13px}
.sgx-mf-key{font-size:10px;font-weight:800;color:#999;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px}
.sgx-mf-val{font-size:13px;color:#1a1a1a;font-weight:500;line-height:1.4;word-break:break-word}
.sgx-specs-table{width:100%;border-collapse:collapse;font-size:14px}
.sgx-specs-table tr:nth-child(even){background:#f9fafb}
.sgx-specs-table td{padding:10px 14px;border-bottom:1px solid #eee}
.sgx-specs-table td:first-child{font-weight:600;color:#333;width:180px}

/* related */
.sgx-related{margin-top:48px}
.sgx-related h2{font-size:20px;font-weight:700;margin-bottom:20px;color:#111}
.sgx-rel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media(max-width:900px){.sgx-rel-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){.sgx-rel-grid{grid-template-columns:1fr}}
.sgx-rel-card{border:1px solid #e8e8e8;border-radius:8px;overflow:hidden;background:#fff;transition:box-shadow .2s}
.sgx-rel-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.1)}
.sgx-rel-img{aspect-ratio:1;background:#f5f5f5;overflow:hidden;display:flex;align-items:center;justify-content:center}
.sgx-rel-img img{max-width:100%;max-height:100%;object-fit:contain}
.sgx-rel-body{padding:12px}
.sgx-rel-title{font-size:13px;font-weight:500;color:#222;margin-bottom:6px;line-height:1.4}
.sgx-rel-price{font-size:13px;color:#555;margin-bottom:10px}
.sgx-rel-price s{color:#aaa;margin-left:4px}
.sgx-rel-btn{display:block;width:100%;padding:8px;background:#0a8ff5;color:#fff;text-align:center;border:none;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;font-family:inherit;transition:background .2s}
.sgx-rel-btn:hover{background:#0878d4}
</style>

<div class="sgx-pg">
<div class="sgx-product-wrap">

  <div class="sgx-breadcrumb">
    <a href="/">Home</a> / <a href="/collections/all">Products</a> / <span>{{ product.title | truncate: 60 }}</span>
  </div>

  <div class="sgx-product-cols">

    <!-- GALLERY -->
    <div>
      <div class="sgx-main-img-wrap">
        <img id="sgxMainImg" src="{{ product.featured_image | img_url: '800x' }}" alt="{{ product.title }}">
        <span class="sgx-custom-badge" id="sgxCustomBadge">Your Image</span>
      </div>
      <div class="sgx-thumbs" id="sgxThumbsRow">
        {%- for img in product.images limit: 6 -%}
          <div class="sgx-thumb {% if forloop.first %}active{% endif %}"
               data-src="{{ img | img_url: '800x' }}"
               onclick="sgxThumb('{{ img | img_url: '800x' }}',this)">
            <img src="{{ img | img_url: '160x' }}" alt="">
          </div>
        {%- endfor -%}
      </div>
    </div>

    <!-- INFO -->
    <div class="sgx-info">
      <h1 class="sgx-title">{{ product.title }}</h1>

      <div class="sgx-price-row">
        <span class="sgx-price-sale" id="sgxPrice">{{ product.selected_or_first_available_variant.price | money }}</span>
        {%- if product.compare_at_price_max > product.price -%}
          <span class="sgx-price-compare">{{ product.compare_at_price_max | money }}</span>
          <span class="sgx-sale-badge">Sale</span>
        {%- endif -%}
      </div>
      <div id="sgxPpsfRow" style="font-size:12px;color:#888;display:none"><span id="sgxPpsfVal"></span> per sq ft ¬∑ area: <span id="sgxAreaVal">‚Äî</span></div>

      <p class="sgx-shoppay">Pay over time &gt;$35 with <a href="#">Shop Pay</a>. <a href="#">Learn more</a></p>
      <div class="sgx-divider"></div>

      <!-- MATERIAL -->
      <div>
        <span class="sgx-label">Material: <span id="sgxMaterialVal">‚Äî</span></span>
        <div class="sgx-pills" id="sgxMaterialPills">
          {%- assign mat_opt = product.options_with_values | where: "name", "Material" | first -%}
          {%- if mat_opt -%}
            {%- for v in mat_opt.values -%}
              <button class="sgx-pill {% if forloop.first %}active{% endif %}"
                      onclick="sgxPickMaterial('{{ v }}',this)">{{ v }}</button>
            {%- endfor -%}
          {%- endif -%}
        </div>
      </div>

      <!-- SIZE -->
      <div class="sgx-size-section">
        <span class="sgx-label" style="margin-bottom:8px">Size: <span id="sgxSizeDisplay">‚Äî</span></span>
        <div class="sgx-size-presets" id="sgxSizePresets"></div>
        <div class="sgx-size-inputs">
          <label>W</label>
          <input class="sgx-dim-input" type="number" id="sgxDimW" min="1" placeholder="18" oninput="sgxOnDimChange(true)">
          <span class="sgx-size-x">√ó</span>
          <label>H</label>
          <input class="sgx-dim-input" type="number" id="sgxDimH" min="1" placeholder="24" oninput="sgxOnDimChange(true)">
          <select class="sgx-dim-unit" id="sgxDimUnit" onchange="sgxOnDimChange(false)">
            <option value="in">in</option>
            <option value="cm">cm</option>
            <option value="ft">ft</option>
          </select>
        </div>
      </div>

      <!-- SIDES -->
      <div class="sgx-sides-wrap">
        <span class="sgx-label" style="margin-bottom:0">Sides: <span id="sgxSidesVal">1 Side</span></span>
        <div class="sgx-sides-row">
          <div class="sgx-side-card active" onclick="sgxPickSides('1 Side',this)">
            <div class="s-icon">‚óªÔ∏è</div><div class="s-label">1 Side</div><div class="s-desc">Single face</div>
          </div>
          <div class="sgx-side-card" onclick="sgxPickSides('2 Sides',this)">
            <div class="s-icon">‚óºÔ∏è</div><div class="s-label">2 Sides</div><div class="s-desc">Both faces</div>
          </div>
        </div>
      </div>

      <!-- UPLOAD -->
      <div class="sgx-upload-wrap">
        <div class="sgx-upload-head">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Upload Your Own Image <span style="font-weight:400;color:#888">(optional)</span>
        </div>
        <div class="sgx-upload-zone" id="sgxUploadZone">
          <input type="file" id="sgxImageFile" accept="image/*" onchange="sgxHandleUpload(this)">
          <div class="sgx-upload-icon">üñºÔ∏è</div>
          <p><strong>Click to upload</strong> or drag & drop</p>
          <p style="margin-top:3px;font-size:11px;color:#888">PNG, JPG, SVG, WEBP ‚Äì Max 10 MB</p>
        </div>
        <div class="sgx-upload-progress" id="sgxUploadProgress">
          <div class="sgx-up-spinner"></div>
          <span class="sgx-up-text">Uploading to cloud‚Ä¶</span>
        </div>
        <div class="sgx-upload-preview" id="sgxUploadPreview">
          <img id="sgxUploadThumb" src="" alt="preview">
          <div class="sgx-up-info">
            <div class="fn" id="sgxUploadName"></div>
            <div class="fs" id="sgxUploadFileSize"></div>
            <div class="fok">‚úì Uploaded ¬∑ shown as product preview</div>
          </div>
          <button class="sgx-upload-remove" onclick="sgxRemoveUpload()">√ó</button>
        </div>
        <div id="sgxUploadError" style="display:none;margin-top:8px;font-size:12px;color:#d42b2b"></div>
      </div>

      <!-- QTY -->
      <div>
        <span class="sgx-label">Quantity</span>
        <div class="sgx-qty-ctrl">
          <button class="sgx-qty-btn" onclick="sgxQty(-1)">‚àí</button>
          <input class="sgx-qty-val" type="number" id="sgxQty" value="1" min="1" max="9999" oninput="sgxRefreshSummary()">
          <button class="sgx-qty-btn" onclick="sgxQty(1)">+</button>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="sgx-summary">
        <div class="sgx-summary-title">Order Summary</div>
        <div class="sgx-sum-row"><span>Material</span><span id="smMat">‚Äî</span></div>
        <div class="sgx-sum-row"><span>Size</span><span id="smSize">‚Äî</span></div>
        <div class="sgx-sum-row"><span>Sides</span><span id="smSides">1 Side</span></div>
        <div class="sgx-sum-row"><span>Quantity</span><span id="smQty">1</span></div>
        <div class="sgx-sum-row total"><span>Price Per Unit</span><span id="smPrice">‚Äî</span></div>
        <div class="sgx-sum-img" id="smImgRow">
          <img id="smImgThumb" src="" alt="">
          <span>Custom image attached ‚úì</span>
        </div>
      </div>

      <!-- BUTTONS -->
      <button class="sgx-btn-atc" id="sgxAtcBtn" onclick="sgxAddToCart()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        Add to cart
      </button>
      <button class="sgx-btn-buy" onclick="sgxBuyNow()">Buy it now</button>
      <button class="sgx-btn-customize" onclick="sgxGoToDesigner()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Customize Your Design
      </button>

      <div class="sgx-cart-msg" id="sgxCartMsg"></div>
      <p class="sgx-social">üî• <strong id="sgxViewers">{{ 'now' | date: '%S' | plus: 12 }}</strong> people viewing now</p>
      <div class="sgx-divider"></div>
      <div class="sgx-meta">
        <strong>SKU:</strong><span id="sgxSku">{{ product.selected_or_first_available_variant.sku | default: 'N/A' }}</span>
        <strong>Categories:</strong><span>{%- for c in product.collections -%}{{ c.title }}{% unless forloop.last %}, {% endunless %}{%- else -%}Signs{%- endfor -%}</span>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div>
    <div class="sgx-tabs">
      <button class="sgx-tab-btn active" onclick="sgxTab('desc',this)">Description</button>
      <button class="sgx-tab-btn" onclick="sgxTab('specs',this)">Specifications</button>
    </div>
    <div class="sgx-tab-panel active" id="sgxPanel-desc">
      <div class="sgx-tab-content">{{ product.description }}</div>
      <div class="sgx-mf-section" id="sgxMfCards" style="display:none">
        <h3>Product Details</h3>
        <div class="sgx-mf-grid" id="sgxMfGrid"></div>
      </div>
    </div>
    <div class="sgx-tab-panel" id="sgxPanel-specs">
      <table class="sgx-specs-table" id="sgxSpecsTable"></table>
      <p id="sgxSpecsEmpty" style="font-size:14px;color:#888;padding:16px 0;display:none">No specifications available.</p>
    </div>
  </div>

  <!-- RELATED -->
  <div class="sgx-related">
    <h2>Related Products</h2>
    <div class="sgx-rel-grid">
      {%- assign shown = 0 -%}
      {%- for col in product.collections limit:1 -%}
        {%- for rp in col.products limit:5 -%}
          {%- unless rp.id == product.id -%}{%- if shown < 4 -%}
          <div class="sgx-rel-card">
            <a href="{{ rp.url }}"><div class="sgx-rel-img">{%- if rp.featured_image -%}<img src="{{ rp.featured_image | img_url:'400x' }}" alt="{{ rp.title }}">{%- endif -%}</div></a>
            <div class="sgx-rel-body">
              <div class="sgx-rel-title">{{ rp.title | truncate:55 }}</div>
              <div class="sgx-rel-price">From {{ rp.price_min | money }}{%- if rp.compare_at_price_max > rp.price_min -%}<s>{{ rp.compare_at_price_max | money }}</s>{%- endif -%}</div>
              <a href="{{ rp.url }}" class="sgx-rel-btn">+ Choose options</a>
            </div>
          </div>
          {%- assign shown = shown | plus:1 -%}
          {%- endif -%}{%- endunless -%}
        {%- endfor -%}
      {%- endfor -%}
    </div>
  </div>

</div></div>

<!-- Metafields raw data for JS -->
<script id="sgxMfRaw" type="application/json">{{ product.metafields.custom | json }}</script>

<script>
(function(){
'use strict';

/* ‚ïê‚ïê‚ïê SHOPIFY DATA ‚ïê‚ïê‚ïê */
const VARIANTS   = {{ product.variants | json }};
const OPT_NAMES  = {{ product.options  | json }};
const PRODUCT_ID = {{ product.id | json }};
const CLOUDINARY_CLOUD = 'dzeolercm';          // ‚Üê your cloud name
const CLOUDINARY_PRESET = 'sign_designs';      // ‚Üê your unsigned upload preset

/* ‚ïê‚ïê‚ïê METAFIELDS ‚ïê‚ïê‚ïê */
let MF_RAW = {};
try { MF_RAW = JSON.parse(document.getElementById('sgxMfRaw').textContent) || {}; } catch(e){}

function parseMfJson(v){
  if(!v || v==='null' || v==='') return null;
  if(typeof v==='object') return v;
  try{
    var first = JSON.parse(v);
    if(typeof first === 'string'){
      try{ return JSON.parse(first); }catch(e){ return first; }
    }
    return first;
  }catch(e){ return null; }
}

const SIZES_MF     = parseMfJson(MF_RAW.sizes);
const MATERIALS_MF = parseMfJson(MF_RAW.materials);
const PPSF         = MF_RAW.price_per_sqft ? parseFloat(MF_RAW.price_per_sqft) : null;

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
const sel = {};
{%- for opt in product.options_with_values -%}
sel[{{ opt.name | json }}] = {{ opt.values | first | json }};
{%- endfor -%}

let currentVariant  = findVariant();
let selectedMat     = '';
let selectedSides   = '1 Side';
let uploadedUrl     = null;
let uploadedThumbEl = null;

/* ‚ïê‚ïê‚ïê VARIANT ‚ïê‚ïê‚ïê */
function findVariant(){
  return VARIANTS.find(v=>v.options.every((o,i)=>o===sel[OPT_NAMES[i]]))||VARIANTS[0];
}
function refreshVariant(){
  currentVariant = findVariant();
  if(!currentVariant) return;
  document.getElementById('sgxPrice').textContent = '$'+(currentVariant.price/100).toFixed(2);
  const sku = document.getElementById('sgxSku');
  if(sku) sku.textContent = currentVariant.sku||'N/A';
  sgxRefreshSummary();
}

/* ‚ïê‚ïê‚ïê MATERIAL ‚ïê‚ïê‚ïê */
(function initMaterials(){
  const pills = document.getElementById('sgxMaterialPills');
  const mats  = Array.isArray(MATERIALS_MF) ? MATERIALS_MF : [];
  if(mats.length){
    pills.innerHTML='';
    mats.forEach((m,i)=>{
      const b=document.createElement('button');
      b.className='sgx-pill'+(i===0?' active':'');
      b.textContent=m;
      b.onclick=()=>sgxPickMaterial(m,b);
      pills.appendChild(b);
    });
    selectedMat=mats[0];
    document.getElementById('sgxMaterialVal').textContent=mats[0];
  } else {
    const first=pills.querySelector('.sgx-pill.active');
    if(first){selectedMat=first.textContent.trim();document.getElementById('sgxMaterialVal').textContent=selectedMat;}
  }
})();

window.sgxPickMaterial=function(val,btn){
  selectedMat=val;
  document.getElementById('sgxMaterialVal').textContent=val;
  btn.closest('.sgx-pills').querySelectorAll('.sgx-pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  sel['Material']=val;
  refreshVariant();
};

/* ‚ïê‚ïê‚ïê SIZE PRESETS ‚ïê‚ïê‚ïê */
const DEFAULT_PRESETS=['12" √ó 18"','18" √ó 24"','24" √ó 36"','36" √ó 48"','48" √ó 72"'];
(function initSizes(){
  const presets = Array.isArray(SIZES_MF)&&SIZES_MF.length ? SIZES_MF : DEFAULT_PRESETS;
  const wrap = document.getElementById('sgxSizePresets');
  presets.forEach((s,i)=>{
    const b=document.createElement('button');
    b.className='sgx-preset-btn'+(i===0?' active':'');
    b.textContent=s; b.dataset.size=s;
    b.onclick=()=>sgxPickPreset(s,b);
    wrap.appendChild(b);
  });
  if(presets.length) applyPresetToInputs(presets[0]);
})();

function applyPresetToInputs(str){
  const clean = String(str || '')
    .replace(/["'`]/g,'')
    .replace(/\s*(inches|inch|in\.)\s*/gi,' ')
    .replace(/[√ó]/g,'x')
    .replace(/\s+/g,' ')
    .trim();
  const m = clean.match(/([\d.]+)\s*[xX*]\s*([\d.]+)/);
  if(m){document.getElementById('sgxDimW').value=m[1];document.getElementById('sgxDimH').value=m[2];}
  sgxOnDimChange(false);
}

window.sgxPickPreset=function(val,btn){
  document.querySelectorAll('.sgx-preset-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  applyPresetToInputs(val);
};

window.sgxOnDimChange=function(deactivatePreset){
  if(deactivatePreset) document.querySelectorAll('.sgx-preset-btn').forEach(b=>b.classList.remove('active'));
  const w=document.getElementById('sgxDimW').value;
  const h=document.getElementById('sgxDimH').value;
  const u=document.getElementById('sgxDimUnit').value;
  document.getElementById('sgxSizeDisplay').textContent = w&&h ? `${w}" √ó ${h}" (${u})` : '‚Äî';
  updateAreaCalc(w,h,u);
  sgxRefreshSummary();
};

function updateAreaCalc(w,h,u){
  if(!PPSF||!w||!h){
    document.getElementById('sgxPpsfRow').style.display='none';
    return;
  }
  let wi=parseFloat(w), hi=parseFloat(h);
  if(u==='cm'){wi/=2.54;hi/=2.54;}
  if(u==='ft'){wi*=12;hi*=12;}
  const sqft=(wi*hi/144).toFixed(2);
  document.getElementById('sgxPpsfVal').textContent='$'+PPSF.toFixed(2);
  document.getElementById('sgxAreaVal').textContent=sqft+' sq ft';
  document.getElementById('sgxPpsfRow').style.display='block';
}

/* ‚ïê‚ïê‚ïê SIDES ‚ïê‚ïê‚ïê */
window.sgxPickSides=function(val,card){
  selectedSides=val;
  document.getElementById('sgxSidesVal').textContent=val;
  document.querySelectorAll('.sgx-side-card').forEach(c=>c.classList.remove('active'));
  card.classList.add('active');
  sgxRefreshSummary();
};

/* ‚ïê‚ïê‚ïê SUMMARY ‚ïê‚ïê‚ïê */
window.sgxRefreshSummary=function(){
  const cv=findVariant();
  const qty=parseInt(document.getElementById('sgxQty').value)||1;
  const w=document.getElementById('sgxDimW').value;
  const h=document.getElementById('sgxDimH').value;
  const u=document.getElementById('sgxDimUnit').value;
  const szStr=w&&h?`${w}" √ó ${h}" (${u})`:'‚Äî';
  document.getElementById('smMat').textContent  =selectedMat||'‚Äî';
  document.getElementById('smSize').textContent =szStr;
  document.getElementById('smSides').textContent=selectedSides;
  document.getElementById('smQty').textContent  =qty;
  document.getElementById('smPrice').textContent=cv?'$'+(cv.price/100).toFixed(2):'‚Äî';
  const imgRow=document.getElementById('smImgRow');
  if(uploadedUrl){
    document.getElementById('smImgThumb').src=uploadedUrl;
    imgRow.classList.add('visible');
  } else {
    imgRow.classList.remove('visible');
  }
};

/* ‚ïê‚ïê‚ïê UPLOAD ‚Üí CLOUDINARY ‚ïê‚ïê‚ïê */
/* UPLOAD TO CLOUDINARY */
window.sgxHandleUpload=async function(input){
  const file=input.files[0]; if(!file) return;
  const errEl=document.getElementById('sgxUploadError');
  if(errEl){errEl.style.display='none';errEl.textContent='';}
  if(file.size>10*1024*1024){ if(errEl){errEl.textContent='Max 10 MB';errEl.style.display='block';} input.value=''; return; }
  const prog=document.getElementById('sgxUploadProgress');
  const prev=document.getElementById('sgxUploadPreview');
  prog.classList.add('visible'); prev.classList.remove('visible');
  const localBlob=URL.createObjectURL(file);
  document.getElementById('sgxMainImg').src=localBlob;
  document.getElementById('sgxCustomBadge').style.display='block';
  try{
    const fd=new FormData();
    fd.append('file',file);
    fd.append('upload_preset',CLOUDINARY_PRESET);
    fd.append('folder','sign-designs');
    const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`,{method:'POST',body:fd});
    const data=await res.json();
    if(!data.secure_url) throw new Error(data.error?.message||'Upload failed');
    uploadedUrl=data.secure_url;
    URL.revokeObjectURL(localBlob);
    document.getElementById('sgxMainImg').src=uploadedUrl;
    if(uploadedThumbEl) uploadedThumbEl.remove();
    uploadedThumbEl=document.createElement('div');
    uploadedThumbEl.className='sgx-thumb sgx-thumb-upload active';
    uploadedThumbEl.innerHTML=`<img src="${uploadedUrl}" alt="Your image">`;
    uploadedThumbEl.addEventListener('click',()=>sgxThumb(uploadedUrl,uploadedThumbEl));
    document.querySelectorAll('.sgx-thumb').forEach(t=>t.classList.remove('active'));
    document.getElementById('sgxThumbsRow').appendChild(uploadedThumbEl);
    prog.classList.remove('visible');
    document.getElementById('sgxUploadThumb').src=uploadedUrl;
    document.getElementById('sgxUploadName').textContent=file.name;
    document.getElementById('sgxUploadFileSize').textContent=(file.size/1024).toFixed(0)+' KB';
    prev.classList.add('visible');
    sgxRefreshSummary();
  }catch(err){
    URL.revokeObjectURL(localBlob);
    prog.classList.remove('visible');
    uploadedUrl=null;
    document.getElementById('sgxCustomBadge').style.display='none';
    const orig=document.querySelector('.sgx-thumb[data-src]');
    if(orig) document.getElementById('sgxMainImg').src=orig.dataset.src;
    if(errEl){errEl.textContent='Upload failed: '+err.message;errEl.style.display='block';}
    input.value='';
  }
};

window.sgxRemoveUpload=function(){
  uploadedUrl=null;
  document.getElementById('sgxImageFile').value='';
  document.getElementById('sgxUploadPreview').classList.remove('visible');
  document.getElementById('sgxCustomBadge').style.display='none';
  if(uploadedThumbEl){uploadedThumbEl.remove();uploadedThumbEl=null;}
  const first=document.querySelector('.sgx-thumb[data-src]');
  if(first){document.getElementById('sgxMainImg').src=first.dataset.src;first.classList.add('active');}
  sgxRefreshSummary();
};

/* Drag drop */
(function(){
  const zone=document.getElementById('sgxUploadZone');
  if(!zone) return;
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.classList.remove('drag-over');
    const f=e.dataTransfer?.files?.[0];
    if(f){try{const dt=new DataTransfer();dt.items.add(f);document.getElementById('sgxImageFile').files=dt.files;}catch(_){}sgxHandleUpload({files:[f]});}
  });
})();

/* METAFIELDS UI */
(function initMetafields(){
  const grid=document.getElementById('sgxMfGrid');
  const table=document.getElementById('sgxSpecsTable');
  const cards=document.getElementById('sgxMfCards');
  let count=0;
  if(!MF_RAW || typeof MF_RAW!=='object'){ if(cards) cards.style.display='none'; return; }
  Object.entries(MF_RAW).forEach(([key,val])=>{
    if(!val||val==='null'||val==='') return;
    const prettyKey=key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    let disp=val;
    const parsed=parseMfJson(val);
    if(Array.isArray(parsed)){
      disp=parsed.join(', ');
    }else if(parsed!==null && typeof parsed==='object'){
      disp=JSON.stringify(parsed);
    }else{
      disp=String(val);
      if(disp==='true') disp='Yes';
      if(disp==='false') disp='No';
      if(key==='price_per_sqft' && /^\d+(\.\d+)?$/.test(disp)) disp='$'+parseFloat(disp).toFixed(2)+' per sq ft';
    }
    const card=document.createElement('div');
    card.className='sgx-mf-card';
    card.innerHTML=`<div class="sgx-mf-key">${prettyKey}</div><div class="sgx-mf-val">${disp}</div>`;
    grid.appendChild(card);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${prettyKey}</td><td>${disp}</td>`;
    table.appendChild(tr);
    count++;
  });
  if(count>0){cards.style.display='block';}
  else{document.getElementById('sgxSpecsEmpty').style.display='block';}
})();

/* ‚ïê‚ïê‚ïê CART ‚ïê‚ïê‚ïê */
function getSize(){
  const w=document.getElementById('sgxDimW').value;
  const h=document.getElementById('sgxDimH').value;
  const u=document.getElementById('sgxDimUnit').value;
  return w&&h?`${w}" √ó ${h}" (${u})`:null;
}
function buildProps(){
  const cv=findVariant();
  const qty=parseInt(document.getElementById('sgxQty').value)||1;
  const props={};
  if(selectedMat)     props['Material']      =selectedMat;
  const sz=getSize();
  if(sz)              props['Size']           =sz;
  props['Sides']      =selectedSides;
  props['Quantity']   =String(qty);
  if(cv) props['Price Per Unit']='$'+(cv.price/100).toFixed(2);
  /* ONE image property ‚Äî CDN URL only */
  if(uploadedUrl)     props['Design Image']  =uploadedUrl;
  delete props['Custom Image'];
  delete props['_customImage'];
  delete props['_image'];
  delete props['custom_image'];
  delete props['design_image'];
  delete props['customImage'];
  return props;
}
function refreshCartCount(){
  fetch('/cart.js').then(r=>r.json()).then(cart=>{
    var count=cart.item_count;
    [
      '[data-cart-count]','[data-cart-item-count]','[data-cart-icon-bubble]',
      '[data-cart-badge]','.cart-count','.cart__count','.cart-count-bubble',
      '#CartCount','.js-cart-count','[data-header-cart-quantity]'
    ].forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        el.textContent=count;
        el.setAttribute('data-count',count);
      });
    });
    ['cart:refresh','cart:updated','cart:change'].forEach(function(evName){
      document.documentElement.dispatchEvent(new CustomEvent(evName,{bubbles:true,detail:cart}));
    });
    if(window.theme&&window.theme.cart&&window.theme.cart.getCart) window.theme.cart.getCart();
    if(window.theme&&window.theme.miniCart&&window.theme.miniCart.refresh) window.theme.miniCart.refresh();
    if(window.Shopify&&window.Shopify.onCartUpdate) window.Shopify.onCartUpdate(cart);
  });
}
const CART_SVG=`<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>`;

window.sgxAddToCart=function(){
  const btn=document.getElementById('sgxAtcBtn');
  const msg=document.getElementById('sgxCartMsg');
  const qty=parseInt(document.getElementById('sgxQty').value)||1;
  if(!getSize()){msg.className='sgx-cart-msg err';msg.textContent='‚úï Please enter width and height.';return;}
  btn.disabled=true;btn.textContent='Adding‚Ä¶';msg.className='sgx-cart-msg';
  fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id:currentVariant.id,quantity:qty,properties:buildProps()})})
  .then(r=>r.ok?r.json():r.json().then(e=>{throw new Error(e.description||'Error')}))
  .then(()=>{
    btn.disabled=false;btn.innerHTML=CART_SVG+' Add to cart';
    msg.className='sgx-cart-msg ok';msg.textContent='‚úì Added to cart!';
    refreshCartCount();
  })
  .catch(err=>{
    btn.disabled=false;btn.innerHTML=CART_SVG+' Add to cart';
    msg.className='sgx-cart-msg err';msg.textContent='‚úï '+(err.message||'Failed.');
  });
};
window.sgxBuyNow=function(){
  const qty=parseInt(document.getElementById('sgxQty').value)||1;
  const qs=Object.entries(buildProps()).map(([k,v])=>`properties[${encodeURIComponent(k)}]=${encodeURIComponent(v)}`).join('&');
  window.location.href='/cart/'+currentVariant.id+':'+qty+(qs?'?'+qs:'');
};
window.sgxGoToDesigner=function(){
  window.location.href='{{ product.url }}?view=custom-designer&variant='+currentVariant.id+'&product='+PRODUCT_ID;
};
window.sgxThumb=function(src,el){
  document.getElementById('sgxMainImg').src=src;
  document.querySelectorAll('.sgx-thumb').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sgxCustomBadge').style.display=(el===uploadedThumbEl)?'block':'none';
};
window.sgxQty=function(d){
  const i=document.getElementById('sgxQty');i.value=Math.max(1,(parseInt(i.value)||1)+d);sgxRefreshSummary();
};
window.sgxTab=function(id,btn){
  document.querySelectorAll('.sgx-tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.sgx-tab-btn').forEach(b=>b.classList.remove('active'));
  const p=document.getElementById('sgxPanel-'+id);if(p)p.classList.add('active');
  btn.classList.add('active');
};

let viewers=parseInt(document.getElementById('sgxViewers').textContent)||24;
setInterval(()=>{viewers=Math.max(5,viewers+(Math.random()>.5?1:-1));const e=document.getElementById('sgxViewers');if(e)e.textContent=viewers;},7000);

sgxRefreshSummary();

})();
</script>
